<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoProgram控制面板 - CG版本</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container-fluid {
            padding: 20px;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            margin-bottom: 20px;
        }
        
        .card-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-running { background-color: #ffc107; }
        
        .btn-custom {
            border-radius: 25px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .progress {
            height: 8px;
            border-radius: 4px;
        }
        
        .progress-bar {
            border-radius: 4px;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #495057;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .log-container {
            background-color: #2d3748;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .timestamp {
            color: #a0aec0;
            font-size: 0.8rem;
        }
        
        .autofeeding-status {
            font-size: 1.1rem;
            font-weight: 600;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .autofeeding-stop { background-color: #f8d7da; color: #721c24; }
        .autofeeding-running { background-color: #d4edda; color: #155724; }
        .autofeeding-paused { background-color: #fff3cd; color: #856404; }
        .autofeeding-detecting { background-color: #cce5ff; color: #004085; }
        .autofeeding-vibrating { background-color: #e2e3e5; color: #383d41; }
        
        .prepare-done-true { 
            background-color: #d4edda; 
            color: #155724; 
            border: 2px solid #c3e6cb; 
        }
        .prepare-done-false { 
            background-color: #f8d7da; 
            color: #721c24; 
            border: 2px solid #f5c6cb; 
        }
        
        .auto-program-enabled { 
            background-color: #d1ecf1; 
            color: #0c5460; 
            border: 2px solid #bee5eb; 
        }
        .auto-program-disabled { 
            background-color: #ffeaa7; 
            color: #856404; 
            border: 2px solid #ffeaa7; 
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- 標題欄 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">
                            <i class="fas fa-robot me-2"></i>
                            AutoProgram控制面板 - CG版本
                        </h3>
                        <div class="d-flex align-items-center">
                            <span class="status-indicator" id="connectionStatus"></span>
                            <span id="connectionText">未連接</span>
                            <button class="btn btn-outline-light btn-sm ms-3" id="connectBtn">
                                <i class="fas fa-plug me-1"></i>連接
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 左側控制面板 -->
            <div class="col-lg-6">
                <!-- AutoProgram系統控制 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-play-circle me-2"></i>AutoProgram系統控制
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>系統啟動/停止</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success btn-custom" id="startSystemBtn">
                                        <i class="fas fa-play me-1"></i>啟動系統
                                    </button>
                                    <button class="btn btn-danger btn-custom" id="stopSystemBtn">
                                        <i class="fas fa-stop me-1"></i>停止系統
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>自動程序控制</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary btn-custom" id="enableAutoProgramBtn">
                                        <i class="fas fa-toggle-on me-1"></i>啟用自動程序
                                    </button>
                                    <button class="btn btn-warning btn-custom" id="disableAutoProgramBtn">
                                        <i class="fas fa-toggle-off me-1"></i>停用自動程序
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <small class="text-muted">系統控制地址: 1320 | 自動程序控制地址: 1321</small>
                        </div>
                    </div>
                </div>

                <!-- Flow控制 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-cogs me-2"></i>Flow控制
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Dobot Flow1控制</h6>
                                <div class="d-flex align-items-center mb-3">
                                    <span class="badge" id="flow1StatusBadge">未知</span>
                                    <button class="btn btn-warning btn-sm ms-2" id="triggerDobotFlow1Btn">
                                        <i class="fas fa-play me-1"></i>觸發
                                    </button>
                                    <button class="btn btn-secondary btn-sm ms-1" id="clearFlow1CompleteBtn">
                                        <i class="fas fa-eraser me-1"></i>清除完成
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Dobot Flow5控制</h6>
                                <div class="d-flex align-items-center mb-3">
                                    <span class="badge" id="flow5StatusBadge">未知</span>
                                    <button class="btn btn-success btn-sm ms-2" id="triggerDobotFlow5Btn">
                                        <i class="fas fa-play me-1"></i>觸發
                                    </button>
                                    <button class="btn btn-secondary btn-sm ms-1" id="clearFlow5CompleteBtn">
                                        <i class="fas fa-eraser me-1"></i>清除完成
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6>自動交握控制</h6>
                                <div class="d-grid gap-1">
                                    <button class="btn btn-primary btn-sm" id="autoHandshakeBtn">
                                        <i class="fas fa-handshake me-1"></i>自動交握
                                    </button>
                                    <small class="text-muted">Flow1完成後自動觸發Flow5</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>錯誤處理</h6>
                                <button class="btn btn-danger btn-sm" id="errorClearBtn">
                                    <i class="fas fa-exclamation-triangle me-1"></i>清除錯誤
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AutoFeeding交握控制 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-handshake me-2"></i>AutoFeeding交握控制
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="stat-card">
                                    <div class="stat-number" id="afCgFAvailableDirect">否</div>
                                    <div class="stat-label">CG_F可用(940)</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-card">
                                    <div class="stat-number" id="afCoordsTaken">否</div>
                                    <div class="stat-label">座標已讀取(945)</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-info btn-custom" id="setCoordsTagenBtn">
                                    <i class="fas fa-check me-1"></i>設置已讀取
                                </button>
                                <small class="text-muted d-block mt-1">手動設置945=1</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 目標座標顯示 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-crosshairs me-2"></i>目標座標
                    </div>
                    <div class="card-body">
                        <h6 class="text-center mb-3">AutoProgram複製座標 (1340-1343)</h6>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-number" id="targetX">0.0</div>
                                    <div class="stat-label">目標X座標 (mm)</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-number" id="targetY">0.0</div>
                                    <div class="stat-label">目標Y座標 (mm)</div>
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="text-center mb-3 mt-4">AutoFeeding直接座標 (941-944)</h6>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-number" id="targetXDirect">0.0</div>
                                    <div class="stat-label">直接X座標 (mm)</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-number" id="targetYDirect">0.0</div>
                                    <div class="stat-label">直接Y座標 (mm)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側監控面板 -->
            <div class="col-lg-6">
                <!-- 系統狀態 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-tachometer-alt me-2"></i>系統狀態
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-number" id="systemStatus">停止</div>
                                    <div class="stat-label">系統狀態</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card" id="autoProgramStatusCard">
                                    <div class="stat-number" id="autoProgramEnabled">未知</div>
                                    <div class="stat-label">自動程序狀態</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="stat-card" id="prepareDoneCard">
                                    <div class="stat-number" id="prepareDone">否</div>
                                    <div class="stat-label">Prepare Done</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-number" id="errorCode">0</div>
                                    <div class="stat-label">錯誤代碼</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AutoFeeding狀態 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-industry me-2"></i>AutoFeeding狀態
                    </div>
                    <div class="card-body">
                        <div class="autofeeding-status" id="autofeedingStatus">AutoFeeding模組停止</div>
                        
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="stat-card">
                                    <div class="stat-number" id="afModuleStatus">0</div>
                                    <div class="stat-label">模組狀態</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-card">
                                    <div class="stat-number" id="afCgFAvailable">否</div>
                                    <div class="stat-label">CG_F可用(AP)</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-card">
                                    <div class="stat-number" id="flow5CompleteStatus">否</div>
                                    <div class="stat-label">Flow5完成狀態</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CG檢測結果 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-eye me-2"></i>CG檢測結果
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-3">
                                <div class="stat-card">
                                    <div class="stat-number text-primary" id="cgFCount">0</div>
                                    <div class="stat-label">CG_F數量</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="stat-card">
                                    <div class="stat-number text-success" id="cgBCount">0</div>
                                    <div class="stat-label">CG_B數量</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="stat-card">
                                    <div class="stat-number text-warning" id="stackCount">0</div>
                                    <div class="stat-label">STACK數量</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="stat-card">
                                    <div class="stat-number text-info" id="totalDetections">0</div>
                                    <div class="stat-label">總檢測數量</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dobot M1Pro狀態 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-robot me-2"></i>Dobot M1Pro狀態
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6>當前Flow: <span class="badge bg-info" id="currentFlowBadge">無</span></h6>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>運動進度</span>
                                <span id="motionProgressText">0%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-primary" id="motionProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="stat-card">
                                    <div class="stat-number" id="dobotMotionStatus">0</div>
                                    <div class="stat-label">運動狀態</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-card">
                                    <div class="stat-number" id="dobotFlow1Complete">否</div>
                                    <div class="stat-label">Flow1完成</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-card">
                                    <div class="stat-number" id="dobotFlow5Complete">否</div>
                                    <div class="stat-label">Flow5完成</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 協調統計 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-bar me-2"></i>協調統計
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="stat-card">
                                    <div class="stat-number" id="coordinationCycleCount">0</div>
                                    <div class="stat-label">協調週期</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-card">
                                    <div class="stat-number" id="flow1TriggerCount">0</div>
                                    <div class="stat-label">Flow1觸發次數</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-card">
                                    <div class="stat-number" id="flow5CompleteCount">0</div>
                                    <div class="stat-label">Flow5完成次數</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row text-center mt-3">
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-number" id="cgFTakenCount">0</div>
                                    <div class="stat-label">CG_F取得次數</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-number" id="vpStatus">0</div>
                                    <div class="stat-label">VP模組狀態</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作日誌 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-list me-2"></i>操作日誌</span>
                        <button class="btn btn-outline-light btn-sm" id="clearLogBtn">
                            <i class="fas fa-trash me-1"></i>清除日誌
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="log-container" id="logContainer">
                            <div class="timestamp">[系統啟動]</div>
                            <div>AutoProgram控制面板已載入，等待連接...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <script>
        // Socket.IO連接
        const socket = io();
        
        // DOM元素
        const elements = {
            connectionStatus: document.getElementById('connectionStatus'),
            connectionText: document.getElementById('connectionText'),
            connectBtn: document.getElementById('connectBtn'),
            
            // 系統控制
            startSystemBtn: document.getElementById('startSystemBtn'),
            stopSystemBtn: document.getElementById('stopSystemBtn'),
            enableAutoProgramBtn: document.getElementById('enableAutoProgramBtn'),
            disableAutoProgramBtn: document.getElementById('disableAutoProgramBtn'),
            
            // Flow控制
            triggerDobotFlow1Btn: document.getElementById('triggerDobotFlow1Btn'),
            clearFlow1CompleteBtn: document.getElementById('clearFlow1CompleteBtn'),
            triggerDobotFlow5Btn: document.getElementById('triggerDobotFlow5Btn'),
            clearFlow5CompleteBtn: document.getElementById('clearFlow5CompleteBtn'),
            errorClearBtn: document.getElementById('errorClearBtn'),
            autoHandshakeBtn: document.getElementById('autoHandshakeBtn'),
            setCoordsTagenBtn: document.getElementById('setCoordsTagenBtn'),
            
            // 狀態顯示
            flow1StatusBadge: document.getElementById('flow1StatusBadge'),
            flow5StatusBadge: document.getElementById('flow5StatusBadge'),
            systemStatus: document.getElementById('systemStatus'),
            autoProgramEnabled: document.getElementById('autoProgramEnabled'),
            autoProgramStatusCard: document.getElementById('autoProgramStatusCard'),
            prepareDone: document.getElementById('prepareDone'),
            prepareDoneCard: document.getElementById('prepareDoneCard'),
            errorCode: document.getElementById('errorCode'),
            
            // AutoFeeding狀態
            autofeedingStatus: document.getElementById('autofeedingStatus'),
            afModuleStatus: document.getElementById('afModuleStatus'),
            afCgFAvailable: document.getElementById('afCgFAvailable'),
            afCgFAvailableDirect: document.getElementById('afCgFAvailableDirect'),
            afCoordsTaken: document.getElementById('afCoordsTaken'),
            flow5CompleteStatus: document.getElementById('flow5CompleteStatus'),
            
            // CG檢測結果
            cgFCount: document.getElementById('cgFCount'),
            cgBCount: document.getElementById('cgBCount'),
            stackCount: document.getElementById('stackCount'),
            totalDetections: document.getElementById('totalDetections'),
            
            // Dobot狀態
            currentFlowBadge: document.getElementById('currentFlowBadge'),
            motionProgressBar: document.getElementById('motionProgressBar'),
            motionProgressText: document.getElementById('motionProgressText'),
            dobotMotionStatus: document.getElementById('dobotMotionStatus'),
            dobotFlow1Complete: document.getElementById('dobotFlow1Complete'),
            dobotFlow5Complete: document.getElementById('dobotFlow5Complete'),
            
            // 目標座標
            targetX: document.getElementById('targetX'),
            targetY: document.getElementById('targetY'),
            targetXDirect: document.getElementById('targetXDirect'),
            targetYDirect: document.getElementById('targetYDirect'),
            
            // 統計
            coordinationCycleCount: document.getElementById('coordinationCycleCount'),
            flow1TriggerCount: document.getElementById('flow1TriggerCount'),
            flow5CompleteCount: document.getElementById('flow5CompleteCount'),
            cgFTakenCount: document.getElementById('cgFTakenCount'),
            vpStatus: document.getElementById('vpStatus'),
            
            // 日誌
            logContainer: document.getElementById('logContainer'),
            clearLogBtn: document.getElementById('clearLogBtn')
        };
        
        // 狀態變數
        let isConnected = false;
        let isAutoHandshakeRunning = false;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateConnectionStatus(false);
        });
        
        // 設置事件監聽器
        function setupEventListeners() {
            // 連接按鈕
            elements.connectBtn.addEventListener('click', toggleConnection);
            
            // 系統控制
            elements.startSystemBtn.addEventListener('click', () => controlSystem('start'));
            elements.stopSystemBtn.addEventListener('click', () => controlSystem('stop'));
            elements.enableAutoProgramBtn.addEventListener('click', () => controlAutoProgram('enable'));
            elements.disableAutoProgramBtn.addEventListener('click', () => controlAutoProgram('disable'));
            
            // Flow控制
            elements.triggerDobotFlow1Btn.addEventListener('click', () => controlDobotFlow1('trigger'));
            elements.clearFlow1CompleteBtn.addEventListener('click', () => controlFlowComplete('clear_flow1'));
            elements.triggerDobotFlow5Btn.addEventListener('click', () => controlDobotFlow5('trigger'));
            elements.clearFlow5CompleteBtn.addEventListener('click', () => controlFlowComplete('clear_flow5'));
            elements.errorClearBtn.addEventListener('click', errorClear);
            elements.autoHandshakeBtn.addEventListener('click', executeAutoHandshake);
            elements.setCoordsTagenBtn.addEventListener('click', setCoordsToken);
            
            // 清除日誌
            elements.clearLogBtn.addEventListener('click', clearLog);
        }
        
        // Socket.IO事件處理
        socket.on('connect', function() {
            logMessage('SocketIO連接成功');
        });
        
        socket.on('disconnect', function() {
            logMessage('SocketIO連接斷開');
            updateConnectionStatus(false);
        });
        
        socket.on('status_update', function(data) {
            updateSystemStatus(data);
        });
        
        // 連接控制
        async function toggleConnection() {
            if (isConnected) {
                await disconnectModbus();
            } else {
                await connectModbus();
            }
        }
        
        async function connectModbus() {
            try {
                logMessage('正在連接Modbus服務器...');
                
                const response = await fetch('/api/connect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (result.success) {
                    logMessage('Modbus連接成功');
                    updateConnectionStatus(true);
                    if (result.status) {
                        updateSystemStatus(result.status);
                    }
                } else {
                    logMessage(`Modbus連接失敗: ${result.message}`);
                    updateConnectionStatus(false);
                }
                
            } catch (error) {
                logMessage(`連接錯誤: ${error.message}`);
                updateConnectionStatus(false);
            }
        }
        
        async function disconnectModbus() {
            try {
                const response = await fetch('/api/disconnect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                logMessage(result.message);
                updateConnectionStatus(false);
                
            } catch (error) {
                logMessage(`斷開連接錯誤: ${error.message}`);
            }
        }
        
        // 系統控制
        async function controlSystem(action) {
            try {
                logMessage(`正在${action === 'start' ? '啟動' : '停止'}AutoProgram系統...`);
                
                const response = await fetch('/api/control/system', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: action})
                });
                
                const result = await response.json();
                logMessage(result.message);
                
            } catch (error) {
                logMessage(`系統控制錯誤: ${error.message}`);
            }
        }
        
        // 自動程序控制
        async function controlAutoProgram(action) {
            try {
                const actionText = action === 'enable' ? '啟用' : '停用';
                logMessage(`正在${actionText}自動程序...`);
                
                const response = await fetch('/api/control/auto_program', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: action})
                });
                
                const result = await response.json();
                logMessage(result.message);
                
            } catch (error) {
                logMessage(`自動程序控制錯誤: ${error.message}`);
            }
        }
        
        // Dobot Flow1控制
        async function controlDobotFlow1(action) {
            try {
                const actionText = action === 'trigger' ? '觸發Dobot Flow1' : '清除Dobot Flow1';
                logMessage(`正在${actionText}...`);
                
                const response = await fetch('/api/control/dobot_flow1', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: action})
                });
                
                const result = await response.json();
                logMessage(result.message);
                
            } catch (error) {
                logMessage(`Dobot Flow1控制錯誤: ${error.message}`);
            }
        }
        
        // Dobot Flow5控制
        async function controlDobotFlow5(action) {
            try {
                const actionText = action === 'trigger' ? '觸發Dobot Flow5' : '清除Dobot Flow5';
                logMessage(`正在${actionText}...`);
                
                const response = await fetch('/api/control/dobot_flow5', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: action})
                });
                
                const result = await response.json();
                logMessage(result.message);
                
            } catch (error) {
                logMessage(`Dobot Flow5控制錯誤: ${error.message}`);
            }
        }
        
        // Flow完成狀態控制
        async function controlFlowComplete(action) {
            try {
                const actionText = action === 'clear_flow1' ? '清除Flow1完成狀態' : '清除Flow5完成狀態';
                logMessage(`正在${actionText}...`);
                
                const response = await fetch('/api/control/flow_complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: action})
                });
                
                const result = await response.json();
                logMessage(result.message);
                
            } catch (error) {
                logMessage(`Flow完成狀態控制錯誤: ${error.message}`);
            }
        }
        
        // 設置座標已讀取
        async function setCoordsToken() {
            try {
                logMessage('正在設置座標已讀取標誌...');
                
                const response = await fetch('/api/control/coords_taken', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                logMessage(result.message);
                
            } catch (error) {
                logMessage(`設置座標已讀取標誌錯誤: ${error.message}`);
            }
        }
        
        // 自動交握
        async function executeAutoHandshake() {
            if (isAutoHandshakeRunning) {
                logMessage('自動交握流程已在執行中，請稍後...');
                return;
            }
            
            try {
                isAutoHandshakeRunning = true;
                elements.autoHandshakeBtn.disabled = true;
                elements.autoHandshakeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>執行中...';
                
                logMessage('正在執行自動交握流程...');
                
                const response = await fetch('/api/control/auto_handshake', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                logMessage(result.message);
                
            } catch (error) {
                logMessage(`自動交握錯誤: ${error.message}`);
            } finally {
                isAutoHandshakeRunning = false;
                elements.autoHandshakeBtn.disabled = false;
                elements.autoHandshakeBtn.innerHTML = '<i class="fas fa-handshake me-1"></i>自動交握';
            }
        }
        
        // 錯誤清除
        async function errorClear() {
            try {
                logMessage('正在清除錯誤...');
                
                const response = await fetch('/api/control/error_clear', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                logMessage(result.message);
                
            } catch (error) {
                logMessage(`錯誤清除失敗: ${error.message}`);
            }
        }
        
        // 更新連接狀態
        function updateConnectionStatus(connected) {
            isConnected = connected;
            
            if (connected) {
                elements.connectionStatus.className = 'status-indicator status-online';
                elements.connectionText.textContent = '已連接';
                elements.connectBtn.innerHTML = '<i class="fas fa-unplug me-1"></i>斷開';
                elements.connectBtn.className = 'btn btn-outline-light btn-sm ms-3';
            } else {
                elements.connectionStatus.className = 'status-indicator status-offline';
                elements.connectionText.textContent = '未連接';
                elements.connectBtn.innerHTML = '<i class="fas fa-plug me-1"></i>連接';
                elements.connectBtn.className = 'btn btn-outline-light btn-sm ms-3';
            }
            
            // 更新按鈕狀態
            const controlButtons = [
                elements.startSystemBtn, elements.stopSystemBtn,
                elements.enableAutoProgramBtn, elements.disableAutoProgramBtn,
                elements.triggerDobotFlow1Btn, elements.clearFlow1CompleteBtn,
                elements.triggerDobotFlow5Btn, elements.clearFlow5CompleteBtn,
                elements.errorClearBtn, elements.autoHandshakeBtn, elements.setCoordsTagenBtn
            ];
            
            controlButtons.forEach(btn => {
                btn.disabled = !connected;
            });
        }
        
        // 更新系統狀態
        function updateSystemStatus(status) {
            // 基本系統狀態
            elements.systemStatus.textContent = status.system_running || '未知';
            elements.autoProgramEnabled.textContent = status.auto_program_enabled ? '啟用' : '停用';
            elements.prepareDone.textContent = status.prepare_done ? '是' : '否';
            elements.errorCode.textContent = status.error_code || 0;
            
            // 更新prepare_done樣式
            updatePrepareDoneStyle(status.prepare_done);
            
            // 更新自動程序啟用樣式
            updateAutoProgramStyle(status.auto_program_enabled);
            
            // Flow狀態
            updateFlowStatus(status);
            
            // AutoFeeding狀態
            elements.autofeedingStatus.textContent = status.autofeeding_process_status || '未知';
            updateAutofeedingStatusStyle(status.autofeeding_process_status);
            elements.afModuleStatus.textContent = status.af_module_status || 0;
            elements.afCgFAvailable.textContent = status.af_cg_f_available ? '是' : '否';
            elements.afCgFAvailableDirect.textContent = status.af_cg_f_available_direct ? '是' : '否';
            elements.afCoordsTaken.textContent = status.af_coords_taken ? '是' : '否';
            elements.flow5CompleteStatus.textContent = status.flow5_complete_status ? '是' : '否';
            
            // CG檢測結果
            elements.cgFCount.textContent = status.cg_f_count || 0;
            elements.cgBCount.textContent = status.cg_b_count || 0;
            elements.stackCount.textContent = status.stack_count || 0;
            elements.totalDetections.textContent = status.total_detections || 0;
            
            // Dobot狀態
            updateCurrentFlow(status.dobot_current_flow);
            updateMotionProgress(status.dobot_motion_progress);
            elements.dobotMotionStatus.textContent = status.dobot_motion_status || 0;
            elements.dobotFlow1Complete.textContent = status.dobot_flow1_complete ? '是' : '否';
            elements.dobotFlow5Complete.textContent = status.dobot_flow5_complete ? '是' : '否';
            
            // 目標座標
            elements.targetX.textContent = (status.target_x || 0).toFixed(1);
            elements.targetY.textContent = (status.target_y || 0).toFixed(1);
            elements.targetXDirect.textContent = (status.target_x_direct || 0).toFixed(1);
            elements.targetYDirect.textContent = (status.target_y_direct || 0).toFixed(1);
            
            // 統計資訊
            elements.coordinationCycleCount.textContent = status.coordination_cycle_count || 0;
            elements.flow1TriggerCount.textContent = status.flow1_trigger_count || 0;
            elements.flow5CompleteCount.textContent = status.flow5_complete_count || 0;
            elements.cgFTakenCount.textContent = status.cg_f_taken_count || 0;
            elements.vpStatus.textContent = status.vp_status || 0;
        }
        
        // 更新prepare_done樣式
        function updatePrepareDoneStyle(prepareDone) {
            elements.prepareDoneCard.className = 'stat-card';
            if (prepareDone) {
                elements.prepareDoneCard.classList.add('prepare-done-true');
            } else {
                elements.prepareDoneCard.classList.add('prepare-done-false');
            }
        }
        
        // 更新自動程序啟用樣式
        function updateAutoProgramStyle(enabled) {
            elements.autoProgramStatusCard.className = 'stat-card';
            if (enabled) {
                elements.autoProgramStatusCard.classList.add('auto-program-enabled');
            } else {
                elements.autoProgramStatusCard.classList.add('auto-program-disabled');
            }
        }
        
        // 更新Flow狀態
        function updateFlowStatus(status) {
            // Flow1狀態
            if (status.dobot_flow1_complete) {
                elements.flow1StatusBadge.className = 'badge bg-success';
                elements.flow1StatusBadge.textContent = '已完成';
            } else {
                elements.flow1StatusBadge.className = 'badge bg-secondary';
                elements.flow1StatusBadge.textContent = '未完成';
            }
            
            // Flow5狀態
            if (status.dobot_flow5_complete) {
                elements.flow5StatusBadge.className = 'badge bg-success';
                elements.flow5StatusBadge.textContent = '已完成';
            } else {
                elements.flow5StatusBadge.className = 'badge bg-secondary';
                elements.flow5StatusBadge.textContent = '未完成';
            }
        }
        
        // 更新AutoFeeding狀態樣式
        function updateAutofeedingStatusStyle(status) {
            // 移除所有狀態類
            elements.autofeedingStatus.className = 'autofeeding-status';
            
            // 根據狀態添加對應類
            if (!status || status.includes('停止')) {
                elements.autofeedingStatus.classList.add('autofeeding-stop');
            } else if (status.includes('運行')) {
                elements.autofeedingStatus.classList.add('autofeeding-running');
            } else if (status.includes('暫停')) {
                elements.autofeedingStatus.classList.add('autofeeding-paused');
            } else if (status.includes('檢測')) {
                elements.autofeedingStatus.classList.add('autofeeding-detecting');
            } else if (status.includes('震動')) {
                elements.autofeedingStatus.classList.add('autofeeding-vibrating');
            } else {
                elements.autofeedingStatus.classList.add('autofeeding-running');
            }
        }
        
        // 更新當前Flow
        function updateCurrentFlow(flowId) {
            const flowNames = {
                0: '無',
                1: 'Flow1',
                2: 'Flow2',
                5: 'Flow5'
            };
            
            const flowName = flowNames[flowId] || `Flow${flowId}`;
            elements.currentFlowBadge.textContent = flowName;
            
            if (flowId === 0) {
                elements.currentFlowBadge.className = 'badge bg-secondary';
            } else if (flowId === 1) {
                elements.currentFlowBadge.className = 'badge bg-success';
            } else if (flowId === 5) {
                elements.currentFlowBadge.className = 'badge bg-primary';
            } else {
                elements.currentFlowBadge.className = 'badge bg-info';
            }
        }
        
        // 更新運動進度
        function updateMotionProgress(progress) {
            const progressValue = progress || 0;
            elements.motionProgressBar.style.width = `${progressValue}%`;
            elements.motionProgressText.textContent = `${progressValue}%`;
        }
        
        // 日誌功能
        function logMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `
                <div class="timestamp">[${timestamp}]</div>
                <div>${message}</div>
            `;
            
            elements.logContainer.appendChild(logEntry);
            elements.logContainer.scrollTop = elements.logContainer.scrollHeight;
        }
        
        function clearLog() {
            elements.logContainer.innerHTML = `
                <div class="timestamp">[日誌已清除]</div>
                <div>操作日誌已清空</div>
            `;
        }
    </script>
</body>
</html>